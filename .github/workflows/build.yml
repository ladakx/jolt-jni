name: Jolt JNI Nightly Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write # Потрібно для створення релізів

jobs:
  # --- 1. Збірка чистого JAR (Java API) ---
  build-java-jar:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - name: Build Java JAR
        run: ./gradlew clean jar -x checkstyleMain -x checkstyleTest -x test -x javadoc --console=plain
      - name: Rename JAR
        run: mv build/libs/*.jar jolt-jni-api.jar
      - uses: actions/upload-artifact@v4
        with:
          name: jolt-jni-api-jar
          path: jolt-jni-api.jar

  # --- 2. Linux PC (x64, x64_fma) ---
  build-linux-pc:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        target: [Linux64, Linux64_fma]
        flavor: [Sp, Dp]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true
      - name: Build Native Lib
        run: |
          ./gradlew -Pbt=Release -Pflavor=${{ matrix.flavor }} -Ptarget=${{ matrix.target }} -PuseVK=yes \
            -x checkstyleMain -x checkstyleTest -x test -x javadoc assemble --console=plain
      - name: Rename Artifact
        run: |
          LIB_PATH=$(find . -name "libjolt-jni.so" | head -n 1)
          mv "$LIB_PATH" "libjolt-jni-${{ matrix.target }}-${{ matrix.flavor }}.so"
      - uses: actions/upload-artifact@v4
        with:
          name: libs-linux-pc-${{ matrix.target }}-${{ matrix.flavor }}
          path: "*.so"

  # --- 3. Linux Cross-Compile (ARM, LoongArch) ---
  build-linux-cross:
    # Виправлено: runs-on тепер береться виключно з матриці
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: Linux_ARM32hf
            flavor: Sp
            pkg: g++-9-arm-linux-gnueabihf
            exe: arm-linux-gnueabihf-g++-9
            os: ubuntu-22.04
          - target: Linux_ARM32hf
            flavor: Dp
            pkg: g++-9-arm-linux-gnueabihf
            exe: arm-linux-gnueabihf-g++-9
            os: ubuntu-22.04
          - target: Linux_ARM64
            flavor: Sp
            pkg: g++-10-aarch64-linux-gnu
            exe: aarch64-linux-gnu-g++-10
            os: ubuntu-22.04
          - target: Linux_ARM64
            flavor: Dp
            pkg: g++-10-aarch64-linux-gnu
            exe: aarch64-linux-gnu-g++-10
            os: ubuntu-22.04
          - target: Linux_LoongArch64
            flavor: Sp
            pkg: g++-13-loongarch64-linux-gnu
            exe: loongarch64-linux-gnu-g++-13
            os: ubuntu-24.04
          - target: Linux_LoongArch64
            flavor: Dp
            pkg: g++-13-loongarch64-linux-gnu
            exe: loongarch64-linux-gnu-g++-13
            os: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install Cross Compiler
        run: |
          sudo apt-get update
          sudo apt install ${{ matrix.pkg }}
          ${{ matrix.exe }} --version
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - name: Build Native Lib
        run: |
          ./gradlew -Pbt=Release -Pflavor=${{ matrix.flavor }} -Ptarget=${{ matrix.target }} \
            -x checkstyleMain -x checkstyleTest -x test -x javadoc assemble --console=plain
      - name: Rename Artifact
        run: |
          LIB_PATH=$(find . -name "libjolt-jni.so" | head -n 1)
          mv "$LIB_PATH" "libjolt-jni-${{ matrix.target }}-${{ matrix.flavor }}.so"
      - uses: actions/upload-artifact@v4
        with:
          name: libs-linux-cross-${{ matrix.target }}-${{ matrix.flavor }}
          path: "*.so"

  # --- 4. Windows (x64, AVX2) ---
  build-windows:
    runs-on: windows-2022
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        target: [Windows64, Windows64_avx2]
        flavor: [Sp, Dp]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true
      - name: Build Native Lib
        run: |
          ./gradlew -Pbt=Release -Pflavor=${{ matrix.flavor }} -Ptarget=${{ matrix.target }} -PuseVK=yes \
            -x checkstyleMain -x checkstyleTest -x test -x javadoc assemble --console=plain
      - name: Rename Artifact
        run: |
          LIB_PATH=$(find . -name "jolt-jni.dll" | head -n 1)
          mv "$LIB_PATH" "jolt-jni-${{ matrix.target }}-${{ matrix.flavor }}.dll"
      - uses: actions/upload-artifact@v4
        with:
          name: libs-windows-${{ matrix.target }}-${{ matrix.flavor }}
          path: "*.dll"

  # --- 5. macOS (x64, ARM64) ---
  build-macos:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Intel Mac
          - target: MacOSX64
            flavor: Sp
            os: macos-13 # macos-13 is Intel on GitHub Actions
          - target: MacOSX64
            flavor: Dp
            os: macos-13
          # Apple Silicon Mac
          - target: MacOSX_ARM64
            flavor: Sp
            os: macos-15 # macos-14/15 is ARM on GitHub Actions
          - target: MacOSX_ARM64
            flavor: Dp
            os: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - name: Build Native Lib
        run: |
          ./gradlew -Pbt=Release -Pflavor=${{ matrix.flavor }} -Ptarget=${{ matrix.target }} \
            -x checkstyleMain -x checkstyleTest -x test -x javadoc assemble --console=plain
      - name: Rename Artifact
        run: |
          LIB_PATH=$(find . -name "libjolt-jni.dylib" | head -n 1)
          mv "$LIB_PATH" "libjolt-jni-${{ matrix.target }}-${{ matrix.flavor }}.dylib"
      - uses: actions/upload-artifact@v4
        with:
          name: libs-macos-${{ matrix.target }}-${{ matrix.flavor }}
          path: "*.dylib"

  # --- 6. Публікація Nightly Release ---
  nightly-release:
    needs: [build-java-jar, build-linux-pc, build-linux-cross, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true # Це розпакує всі унікальні файли в одну папку

      - name: Display Artifacts
        run: ls -R artifacts

      - name: Create Nightly Release
        uses: ncipollo/release-action@v1
        with:
          name: "Nightly Build"
          tag: "nightly"
          body: "Jolt JNI Nightly Build triggered by commit ${{ github.sha }}."
          artifacts: "artifacts/*"
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}