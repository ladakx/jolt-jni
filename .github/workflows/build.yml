name: Build & Publish Release

on: [push, workflow_dispatch]

permissions:
  contents: write

jobs:
  # ==========================================
  # 1. LINUX BUILD
  # ==========================================
  Linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true
      
      - name: Build & Collect
        run: |
          mkdir -p dist
          # Debug
          ./gradlew -Ptarget=Linux64 -Pbt=Debug -PuseVK=yes build -x checkstyleMain -x checkstyleTest --console=plain
          cp build/libs/*.jar dist/jolt-jni-linux-debug.jar
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-debug.so \;
          # Release
          ./gradlew clean
          ./gradlew -Ptarget=Linux64 -Pbt=Release -PuseVK=yes build -x checkstyleMain -x checkstyleTest --console=plain
          cp build/libs/*.jar dist/jolt-jni-linux-release.jar
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-release.so \;

      - uses: actions/upload-artifact@v4
        with:
          name: linux-files
          path: dist/*

  # ==========================================
  # 2. WINDOWS BUILD
  # ==========================================
  Windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true

      - name: Build & Collect
        shell: bash
        run: |
          mkdir -p dist
          # Debug
          ./gradlew -Ptarget=Windows64 -Pbt=Debug -PuseVK=yes build -x checkstyleMain -x checkstyleTest --console=plain
          cp build/libs/*.jar dist/jolt-jni-windows-debug.jar
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-debug.dll \;
          # Release
          ./gradlew clean
          ./gradlew -Ptarget=Windows64 -Pbt=Release -PuseVK=yes build -x checkstyleMain -x checkstyleTest --console=plain
          cp build/libs/*.jar dist/jolt-jni-windows-release.jar
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-release.dll \;

      - uses: actions/upload-artifact@v4
        with:
          name: windows-files
          path: dist/*

  # ==========================================
  # 3. MACOS BUILD
  # ==========================================
  MacOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3

      - name: Build & Collect
        run: |
          mkdir -p dist
          # ARM64
          ./gradlew -Ptarget=MacOSX_ARM64 -Pbt=Release build -x checkstyleMain -x checkstyleTest --console=plain
          cp build/libs/*.jar dist/jolt-jni-macos-arm64.jar
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-arm64.dylib \;
          # Intel
          ./gradlew clean
          ./gradlew -Ptarget=MacOSX64 -Pbt=Release build -x checkstyleMain -x checkstyleTest --console=plain
          cp build/libs/*.jar dist/jolt-jni-macos-intel.jar
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-intel.dylib \;

      - uses: actions/upload-artifact@v4
        with:
          name: macos-files
          path: dist/*

  # ==========================================
  # 4. PUBLISH TO RELEASES (THE MAGIC PART)
  # ==========================================
  Publish:
    needs: [Linux, Windows, MacOS]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-files"
          path: all_files
          merge-multiple: true

      - uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          delete_release: true
          tag_name: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          name: Latest Nightly Build
          tag_name: nightly
          prerelease: true
          files: all_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}