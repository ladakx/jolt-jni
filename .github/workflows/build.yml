name: Build Jolt JNI Ultimate

on: [push, workflow_dispatch]

permissions:
  contents: write

jobs:
  Linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - name: Install Cross-Compilers
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-10-aarch64-linux-gnu g++-9-arm-linux-gnueabihf
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true
      
      - name: Build Linux Variants
        run: |
          mkdir -p dist
          
          ./gradlew -Ptarget=Linux64 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-x64-sp.so \;
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-universal.jar \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux64 -Pbt=Release -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-x64-dp.so \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux64_fma -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-x64-fma-sp.so \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux64_fma -Pbt=Release -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-x64-fma-dp.so \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux_ARM64 -Pbt=Release -Pflavor=Sp -PuseVK=no build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-arm64-sp.so \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux_ARM64 -Pbt=Release -Pflavor=Dp -PuseVK=no build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-arm64-dp.so \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux_ARM32hf -Pbt=Release -Pflavor=Sp -PuseVK=no build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-armhf-sp.so \;
          ./gradlew clean

          ./gradlew -Ptarget=Linux_ARM32hf -Pbt=Release -Pflavor=Dp -PuseVK=no build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-armhf-dp.so \;

      - uses: actions/upload-artifact@v4
        with:
          name: linux-files
          path: dist/*

  Windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true

      - name: Build Windows Variants
        shell: bash
        run: |
          mkdir -p dist
          
          ./gradlew -Ptarget=Windows64 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-x64-sp.dll \;
          ./gradlew clean

          ./gradlew -Ptarget=Windows64 -Pbt=Release -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-x64-dp.dll \;
          ./gradlew clean

          ./gradlew -Ptarget=Windows64_avx2 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-avx2-sp.dll \;
          ./gradlew clean

          ./gradlew -Ptarget=Windows64_avx2 -Pbt=Release -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-avx2-dp.dll \;

      - uses: actions/upload-artifact@v4
        with:
          name: windows-files
          path: dist/*

  MacOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3

      - name: Build MacOS Variants
        run: |
          mkdir -p dist
          
          ./gradlew -Ptarget=MacOSX_ARM64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-arm64-sp.dylib \;
          ./gradlew clean

          ./gradlew -Ptarget=MacOSX_ARM64 -Pbt=Release -Pflavor=Dp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-arm64-dp.dylib \;
          ./gradlew clean

          ./gradlew -Ptarget=MacOSX64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-intel-sp.dylib \;
          ./gradlew clean

          ./gradlew -Ptarget=MacOSX64 -Pbt=Release -Pflavor=Dp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-intel-dp.dylib \;

      - uses: actions/upload-artifact@v4
        with:
          name: macos-files
          path: dist/*

  Publish:
    needs: [Linux, Windows, MacOS]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-files"
          path: all_files
          merge-multiple: true

      - uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          delete_release: true
          tag_name: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          name: Latest Jolt-JNI Build
          tag_name: nightly
          prerelease: true
          files: all_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}