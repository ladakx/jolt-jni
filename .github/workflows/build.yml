name: Build All Variants (Sp/Dp, Debug/Release)

on: [push, workflow_dispatch]

permissions:
  contents: write

jobs:
  # ==========================================
  # 1. LINUX BUILD
  # ==========================================
  Linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true
      
      - name: Build & Collect Linux
        run: |
          mkdir -p dist
          
          # --- Single Precision (Sp) ---
          # Debug
          ./gradlew -Ptarget=Linux64 -Pbt=Debug -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-sp-debug.so \;
          # Release
          ./gradlew -Ptarget=Linux64 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-sp-release.so \;
          
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-linux-sp.jar \;

          # --- Clean before Double Precision ---
          ./gradlew clean

          # --- Double Precision (Dp) ---
          # Debug
          ./gradlew -Ptarget=Linux64 -Pbt=Debug -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-dp-debug.so \;
          # Release
          ./gradlew -Ptarget=Linux64 -Pbt=Release -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-dp-release.so \;
          # Jar Dp
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-linux-dp.jar \;

      - uses: actions/upload-artifact@v4
        with:
          name: linux-files
          path: dist/*

  # ==========================================
  # 2. WINDOWS BUILD
  # ==========================================
  Windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true

      - name: Build & Collect Windows
        shell: bash
        run: |
          mkdir -p dist
          
          # --- Single Precision (Sp) ---
          ./gradlew -Ptarget=Windows64 -Pbt=Debug -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-sp-debug.dll \;
          
          ./gradlew -Ptarget=Windows64 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-sp-release.dll \;
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-windows-sp.jar \;

          ./gradlew clean

          # --- Double Precision (Dp) ---
          ./gradlew -Ptarget=Windows64 -Pbt=Debug -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-dp-debug.dll \;
          
          ./gradlew -Ptarget=Windows64 -Pbt=Release -Pflavor=Dp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-dp-release.dll \;
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-windows-dp.jar \;

      - uses: actions/upload-artifact@v4
        with:
          name: windows-files
          path: dist/*

  # ==========================================
  # 3. MACOS BUILD
  # ==========================================
  MacOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3

      - name: Build & Collect MacOS
        run: |
          mkdir -p dist
          
          # --- ARM64 (M1/M2) - SP ---
          ./gradlew -Ptarget=MacOSX_ARM64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-arm64-sp.dylib \;
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-macos-arm64-sp.jar \;
          
          # --- ARM64 (M1/M2) - DP ---
          ./gradlew clean
          ./gradlew -Ptarget=MacOSX_ARM64 -Pbt=Release -Pflavor=Dp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-arm64-dp.dylib \;
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-macos-arm64-dp.jar \;

          # --- INTEL (x64) - SP ---
          ./gradlew clean
          ./gradlew -Ptarget=MacOSX64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-intel-sp.dylib \;
          
          # --- INTEL (x64) - DP ---
          ./gradlew clean
          ./gradlew -Ptarget=MacOSX64 -Pbt=Release -Pflavor=Dp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-intel-dp.dylib \;

      - uses: actions/upload-artifact@v4
        with:
          name: macos-files
          path: dist/*

  # ==========================================
  # 4. PUBLISH TO RELEASES
  # ==========================================
  Publish:
    needs: [Linux, Windows, MacOS]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-files"
          path: all_files
          merge-multiple: true

      - uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          delete_release: true
          tag_name: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          name: Latest Nightly Build
          tag_name: nightly
          prerelease: true
          files: all_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}