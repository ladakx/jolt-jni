name: Nightly Builds

on:
  push:

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build ${{ matrix.os }} / ${{ matrix.target }} / ${{ matrix.flavor }}
    if: contains(toJson(github.event.commits), '[ci skip] ') == false
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            target: Linux64
            needs_vulkan: true
            cross: none
          - os: ubuntu-22.04
            target: Linux64_fma
            needs_vulkan: true
            cross: none
          - os: ubuntu-22.04
            target: Linux_ARM32hf
            needs_vulkan: false
            cross: arm32hf
          - os: ubuntu-22.04
            target: Linux_ARM64
            needs_vulkan: false
            cross: arm64
          - os: ubuntu-24.04
            target: Linux_LoongArch64
            needs_vulkan: false
            cross: loongarch64

          # macOS
          - os: macos-15-intel
            target: MacOSX64
            needs_vulkan: false
            cross: none
          - os: macos-15
            target: MacOSX_ARM64
            needs_vulkan: false
            cross: none

          # Windows
          - os: windows-2022
            target: Windows64
            needs_vulkan: true
            cross: none
          - os: windows-2022
            target: Windows64_avx2
            needs_vulkan: true
            cross: none

        flavor: [Sp, Dp]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: 21

      - uses: gradle/actions/setup-gradle@v5

      # Vulkan (для target'ів де ви раніше збирали з -PuseVK=yes)
      - name: Setup Vulkan SDK
        if: matrix.needs_vulkan == true
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true

      # Cross toolchains (Linux only)
      - name: Install cross toolchain (ARM32hf)
        if: runner.os == 'Linux' && matrix.cross == 'arm32hf'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-9-arm-linux-gnueabihf
          arm-linux-gnueabihf-g++-9 --version

      - name: Install cross toolchain (ARM64)
        if: runner.os == 'Linux' && matrix.cross == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-10-aarch64-linux-gnu
          aarch64-linux-gnu-g++-10 --version

      - name: Install cross toolchain (LoongArch64)
        if: runner.os == 'Linux' && matrix.cross == 'loongarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13-loongarch64-linux-gnu
          loongarch64-linux-gnu-g++-13 --version

      # Build (Release only, no debug; disable checks/tests/smoke)
      - name: Gradle build (Release, no checks)
        shell: bash
        run: |
          set -euxo pipefail

          # Vulkan flag only where needed
          USEVK=""
          if [ "${{ matrix.needs_vulkan }}" = "true" ]; then
            USEVK="-PuseVK=yes"
          fi

          ./gradlew \
            -Pbt=Release \
            -Pflavor=${{ matrix.flavor }} \
            -Ptarget=${{ matrix.target }} \
            ${USEVK} \
            clean build install \
            --console=plain \
            -x test \
            -x check \
            -x checkstyleMain \
            -x checkstyleTest \
            -x runSmokeTestAll \
            -x run

      # Collect outputs (NO ZIP). Adjust patterns if you know exact output dirs.
      - name: Collect build outputs (non-archived)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p out

          # Collect typical native + jar artifacts.
          # Exclude archives (.zip/.tar.*) on purpose.
          # If you know exact output directory, replace this 'find' with explicit paths.
          mapfile -t files < <(find build -type f \
            $ -name "*.so" -o -name "*.dll" -o -name "*.dylib" -o -name "*.jar" $ \
            ! -name "*-sources.jar" \
            ! -name "*-javadoc.jar" \
            2>/dev/null || true)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No artifacts found under build/. You may need to adjust the collector paths."
            # still create marker to see job output
            echo "NO_ARTIFACTS_FOUND for ${{ matrix.target }} ${{ matrix.flavor }}" > out/NO_ARTIFACTS_FOUND.txt
          else
            for f in "${files[@]}"; do
              base="$(basename "$f")"
              # Prefix with target+flavor to avoid collisions in release assets
              cp -v "$f" "out/${{ matrix.target }}-${{ matrix.flavor }}-${base}"
            done
          fi

      - name: Upload job artifact
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ matrix.target }}-${{ matrix.flavor }}
          path: out/*
          if-no-files-found: warn

  nightly_release:
    name: Nightly Release
    runs-on: ubuntu-24.04
    needs: [build]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: all-artifacts

      - name: Prepare release assets list
        id: prep
        shell: bash
        run: |
          set -euxo pipefail
          # Flatten all artifact files into one directory
          mkdir -p release-assets
          find all-artifacts -type f -maxdepth 3 -print -exec cp -v {} release-assets/ \;

          # Create a simple manifest
          (cd release-assets && ls -lah) > RELEASE_ASSETS_MANIFEST.txt

          echo "date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Recreate/overwrite 'nightly' release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail

          TITLE="Nightly ${{ steps.prep.outputs.date }}"
          NOTES="Automated nightly build for commit $GITHUB_SHA"

          # Delete existing nightly release if present (ignore errors)
          gh release delete nightly -y || true

          # (Optional) delete tag nightly if exists (ignore errors)
          git push --delete origin nightly || true

          # Create release with fixed tag 'nightly' so the URL is stable
          gh release create nightly \
            --title "$TITLE" \
            --notes "$NOTES" \
            --prerelease

          # Upload all files (NOT zipped)
          gh release upload nightly release-assets/* --clobber
          gh release upload nightly RELEASE_ASSETS_MANIFEST.txt --clobber