name: Build ALL Platforms (12 Variants)

on: [push, workflow_dispatch]

permissions:
  contents: write

jobs:
  # ==========================================
  # 1. LINUX (Standard + FMA + ARM64 + ARM32)
  # ==========================================
  Linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      
      - name: Install Cross-Compilers
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-10-aarch64-linux-gnu g++-9-arm-linux-gnueabihf

      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true
      
      - name: Build & Collect Linux
        run: |
          mkdir -p dist
          
          # --- 1. Linux x64 (Standard) ---
          ./gradlew -Ptarget=Linux64 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-x64-sp.so \;
          # Зберігаємо ОДИН універсальний JAR
          find build/libs -name "jolt-jni-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" -exec cp {} dist/jolt-jni-universal.jar \;
          ./gradlew clean

          # --- 2. Linux x64 (FMA - Optimized) ---
          ./gradlew -Ptarget=Linux64_fma -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-x64-fma-sp.so \;
          ./gradlew clean

          # --- 3. Linux ARM64 (AARCH64) ---
          ./gradlew -Ptarget=Linux_ARM64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-arm64-sp.so \;
          ./gradlew clean

          # --- 4. Linux ARM32 (armhf) ---
          ./gradlew -Ptarget=Linux_ARM32hf -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.so" -exec cp {} dist/libjolt-jni-linux-armhf-sp.so \;

      - uses: actions/upload-artifact@v4
        with:
          name: linux-files
          path: dist/*

  # ==========================================
  # 2. WINDOWS (Standard + AVX2)
  # ==========================================
  Windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      - uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-query-version: 1.4.341.1
          vulkan-use-cache: true

      - name: Build & Collect Windows
        shell: bash
        run: |
          mkdir -p dist
          
          # --- 1. Windows x64 (Standard) ---
          ./gradlew -Ptarget=Windows64 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-x64-sp.dll \;
          ./gradlew clean

          # --- 2. Windows x64 (AVX2 - Optimized) ---
          ./gradlew -Ptarget=Windows64_avx2 -Pbt=Release -Pflavor=Sp -PuseVK=yes build -x test -x checkstyleMain --console=plain
          find build -name "*.dll" -exec cp {} dist/jolt-jni-windows-avx2-sp.dll \;

      - uses: actions/upload-artifact@v4
        with:
          name: windows-files
          path: dist/*

  # ==========================================
  # 3. MACOS (ARM64 + Intel)
  # ==========================================
  MacOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3

      - name: Build & Collect MacOS
        run: |
          mkdir -p dist
          
          # --- 1. ARM64 (Apple Silicon) ---
          ./gradlew -Ptarget=MacOSX_ARM64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-arm64-sp.dylib \;
          ./gradlew clean

          # --- 2. Intel x64 ---
          ./gradlew -Ptarget=MacOSX64 -Pbt=Release -Pflavor=Sp build -x test -x checkstyleMain --console=plain
          find build -name "*.dylib" -exec cp {} dist/libjolt-jni-macos-intel-sp.dylib \;

      - uses: actions/upload-artifact@v4
        with:
          name: macos-files
          path: dist/*

  # ==========================================
  # 4. ANDROID (All 4 ABIs)
  # ==========================================
  Android:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
      - uses: gradle/actions/setup-gradle@v3
      
      - name: Prepare Sources
        run: ./gradlew classes unpackJoltSource unpackTestFramework unpackVhacdSource --console=plain

      - name: Build Android
        run: ./gradlew --build-file=android.gradle -Pflavor=Sp -Pbt=Release assemble --console=plain

      - name: Extract Android Libs
        run: |
          mkdir -p dist
          find build/libs -name "*.aar" -exec cp {} dist/jolt-jni-android.aar \;
          
          unzip dist/jolt-jni-android.aar -d temp_android
          
          cp temp_android/jni/arm64-v8a/libjolt-jni.so dist/libjolt-jni-android-arm64-v8a.so
          cp temp_android/jni/armeabi-v7a/libjolt-jni.so dist/libjolt-jni-android-armeabi-v7a.so
          cp temp_android/jni/x86/libjolt-jni.so dist/libjolt-jni-android-x86.so
          cp temp_android/jni/x86_64/libjolt-jni.so dist/libjolt-jni-android-x86_64.so

      - uses: actions/upload-artifact@v4
        with:
          name: android-files
          path: dist/*

  # ==========================================
  # 5. PUBLISH TO RELEASES
  # ==========================================
  Publish:
    needs: [Linux, Windows, MacOS, Android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-files"
          path: all_files
          merge-multiple: true

      - uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          delete_release: true
          tag_name: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          name: Latest Nightly Build
          tag_name: nightly
          prerelease: true
          files: all_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}